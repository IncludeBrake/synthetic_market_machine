# SMVM Logging Specification

## Overview

This document defines the comprehensive logging specification for the Synthetic Market Validation Module (SMVM). All logs must be structured JSON with consistent field naming, data types, and redaction rules.

## Log Format Requirements

### Base Structure
All SMVM logs must follow this JSON structure:

```json
{
  "timestamp": "2024-12-01T14:30:52.123456Z",
  "run_id": "RUN-20241201-143052-a1b2c3d4",
  "span_id": "RUN-20241201-143052-a1b2c3d4-0001-ING",
  "agent_id": "smvm-service-01",
  "input_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6",
  "output_hash": "b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7",
  "token_in": 1500,
  "token_out": 2300,
  "cache_hit": false,
  "redaction_applied": true,
  "python_version": "3.12.10",
  "pip_freeze_hash": "c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8",
  "wheel_status": "available",
  "level": "INFO",
  "service": "ingestion",
  "operation": "normalize_data",
  "event_type": "NORMALIZED",
  "message": "Successfully normalized 5 data records",
  "metadata": {}
}
```

## Required Fields

### Timestamp (`timestamp`)
- **Type**: String (ISO 8601)
- **Format**: `YYYY-MM-DDTHH:MM:SS.ffffffZ`
- **Description**: UTC timestamp with microsecond precision
- **Example**: `"2024-12-01T14:30:52.123456Z"`
- **Validation**: Must be valid ISO 8601, must be ≤ current time

### Run ID (`run_id`)
- **Type**: String
- **Format**: `RUN-YYYYMMDD-HHMMSS-xxxxxxxx`
- **Description**: Unique identifier for the entire validation run
- **Example**: `"RUN-20241201-143052-a1b2c3d4"`
- **Validation**: Must match regex pattern, must be consistent across all logs in a run

### Span ID (`span_id`)
- **Type**: String
- **Format**: `RUN-YYYYMMDD-HHMMSS-xxxxxxxx-NNNN-XXX`
- **Description**: Unique identifier for a specific operation span
- **Example**: `"RUN-20241201-143052-a1b2c3d4-0001-ING"`
- **Validation**: Must match regex pattern, must be traceable to run_id

### Agent ID (`agent_id`)
- **Type**: String
- **Format**: `smvm-[service]-[instance]`
- **Description**: Identifier for the service instance generating the log
- **Example**: `"smvm-ingestion-01"`
- **Validation**: Must be non-empty, must identify the specific service instance

### Input Hash (`input_hash`)
- **Type**: String
- **Format**: 64-character hexadecimal (SHA-256)
- **Description**: SHA-256 hash of the operation input data
- **Example**: `"a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"`
- **Validation**: Must be exactly 64 hex characters, must use SHA-256
- **Redaction**: Input data must be hashed before logging

### Output Hash (`output_hash`)
- **Type**: String
- **Format**: 64-character hexadecimal (SHA-256)
- **Description**: SHA-256 hash of the operation output data
- **Example**: `"b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7"`
- **Validation**: Must be exactly 64 hex characters, must use SHA-256
- **Redaction**: Output data must be hashed before logging

### Token In (`token_in`)
- **Type**: Integer
- **Range**: 0 to 100,000
- **Description**: Number of tokens consumed by the operation input
- **Example**: `1500`
- **Validation**: Must be non-negative integer, must be ≤ token ceiling

### Token Out (`token_out`)
- **Type**: Integer
- **Range**: 0 to 100,000
- **Description**: Number of tokens generated by the operation output
- **Example**: `2300`
- **Validation**: Must be non-negative integer, must be ≤ token ceiling

### Cache Hit (`cache_hit`)
- **Type**: Boolean
- **Description**: Whether the operation result was served from cache
- **Example**: `false`
- **Validation**: Must be boolean value

### Redaction Applied (`redaction_applied`)
- **Type**: Boolean
- **Description**: Whether sensitive data redaction was applied to the log
- **Example**: `true`
- **Validation**: Must be boolean value, must be true for any log containing potentially sensitive data

### Python Version (`python_version`)
- **Type**: String
- **Format**: `X.Y.Z` (semantic versioning)
- **Description**: Python version used for the operation
- **Example**: `"3.12.10"`
- **Validation**: Must be valid semantic version, must be 3.12.x or 3.11.13
- **Blocking**: Must reject versions ≥3.13

### Pip Freeze Hash (`pip_freeze_hash`)
- **Type**: String
- **Format**: 64-character hexadecimal (SHA-256)
- **Description**: SHA-256 hash of the `pip freeze` output
- **Example**: `"c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8"`
- **Validation**: Must be exactly 64 hex characters, must use SHA-256
- **Purpose**: Ensures reproducibility across environments

### Wheel Status (`wheel_status`)
- **Type**: String
- **Enum**: `["available", "fallback", "error"]`
- **Description**: Status of wheel package availability
- **Example**: `"available"`
- **Validation**: Must be one of the allowed enum values

## Optional Fields

### Level (`level`)
- **Type**: String
- **Enum**: `["DEBUG", "INFO", "WARN", "ERROR", "CRITICAL"]`
- **Description**: Log level severity
- **Default**: `"INFO"`

### Service (`service`)
- **Type**: String
- **Enum**: `["ingestion", "personas", "competitors", "simulation", "analysis", "overwatch", "memory", "cli"]`
- **Description**: SMVM service generating the log

### Operation (`operation`)
- **Type**: String
- **Description**: Specific operation being performed
- **Example**: `"normalize_data"`, `"synthesize_personas"`

### Event Type (`event_type`)
- **Type**: String
- **Enum**: See `/ledger/event-types.md`
- **Description**: Type of business event being logged

### Message (`message`)
- **Type**: String
- **Description**: Human-readable log message
- **Max Length**: 500 characters
- **Redaction**: Must not contain sensitive data

### Metadata (`metadata`)
- **Type**: Object
- **Description**: Additional context-specific metadata
- **Schema**: Must not contain unknown keys (additionalProperties: false)
- **Redaction**: All sensitive data must be redacted or hashed

## Redaction Rules

### Sensitive Data Types
1. **Personal Information**: Names, emails, addresses, phone numbers
2. **Financial Data**: Account numbers, balances, transaction details
3. **API Keys**: Authentication tokens, secret keys, credentials
4. **Raw Prompts**: LLM prompts and responses (must be hashed)
5. **PII**: Any personally identifiable information

### Redaction Methods
1. **Hashing**: Use SHA-256 for data that needs integrity verification
2. **Masking**: Replace sensitive characters with asterisks
3. **Removal**: Completely remove sensitive fields from logs
4. **Aggregation**: Replace specific values with aggregate statistics

### Redaction Examples
```json
// Before redaction (NEVER LOG THIS)
{
  "user_email": "john.doe@example.com",
  "api_key": "sk-1234567890abcdef",
  "prompt": "Generate a business plan for...",
  "response": "Here is your business plan..."
}

// After redaction (SAFE TO LOG)
{
  "user_hash": "d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9",
  "api_key_hash": "e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0",
  "prompt_hash": "f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1",
  "response_hash": "g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2",
  "redaction_applied": true
}
```

## Log Storage & Retention

### Storage Format
- **Format**: JSON Lines (.jsonl) - one JSON object per line
- **Compression**: Gzip compression for logs older than 24 hours
- **Encryption**: AES-256 encryption for sensitive log data

### Retention Policy
- **Hot Storage**: Last 7 days (immediate access)
- **Warm Storage**: 8-30 days (compressed)
- **Cold Storage**: 31-365 days (archived)
- **Deletion**: After 365 days (configurable)

### Log Rotation
- **Frequency**: Daily rotation at midnight UTC
- **Naming**: `{service}-{date}.jsonl.gz`
- **Size Limit**: 100MB per file before rotation

## Validation & Compliance

### Schema Validation
All logs must validate against this JSON schema:
```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "timestamp": {"type": "string", "format": "date-time"},
    "run_id": {"type": "string", "pattern": "^RUN-\\d{8}-\\d{6}-[a-f0-9]{8}$"},
    "span_id": {"type": "string", "pattern": "^RUN-\\d{8}-\\d{6}-[a-f0-9]{8}-\\d{4}-[A-Z]{3}$"},
    "agent_id": {"type": "string", "minLength": 1},
    "input_hash": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
    "output_hash": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
    "token_in": {"type": "integer", "minimum": 0, "maximum": 100000},
    "token_out": {"type": "integer", "minimum": 0, "maximum": 100000},
    "cache_hit": {"type": "boolean"},
    "redaction_applied": {"type": "boolean"},
    "python_version": {"type": "string", "pattern": "^3\\.(12|11)\\.\\d+$"},
    "pip_freeze_hash": {"type": "string", "pattern": "^[a-f0-9]{64}$"},
    "wheel_status": {"type": "string", "enum": ["available", "fallback", "error"]},
    "level": {"type": "string", "enum": ["DEBUG", "INFO", "WARN", "ERROR", "CRITICAL"]},
    "service": {"type": "string", "enum": ["ingestion", "personas", "competitors", "simulation", "analysis", "overwatch", "memory", "cli"]},
    "operation": {"type": "string"},
    "event_type": {"type": "string"},
    "message": {"type": "string", "maxLength": 500},
    "metadata": {"type": "object", "additionalProperties": false}
  },
  "required": ["timestamp", "run_id", "span_id", "agent_id", "input_hash", "output_hash", "token_in", "token_out", "cache_hit", "redaction_applied", "python_version", "pip_freeze_hash", "wheel_status"],
  "additionalProperties": false
}
```

### Compliance Checks
- [ ] All required fields present
- [ ] Field types match specification
- [ ] String patterns match regex
- [ ] Numeric ranges are valid
- [ ] Enum values are allowed
- [ ] Redaction rules applied
- [ ] No unknown fields (additionalProperties: false)

## Implementation Guidelines

### Log Generation
```python
import json
import hashlib
from datetime import datetime
from pathlib import Path

def log_event(event_data: dict, log_file: Path):
    """Generate a compliant SMVM log entry"""

    # Add required timestamp
    event_data["timestamp"] = datetime.utcnow().isoformat() + "Z"

    # Ensure required fields are present
    required_fields = [
        "run_id", "span_id", "agent_id", "input_hash", "output_hash",
        "token_in", "token_out", "cache_hit", "redaction_applied",
        "python_version", "pip_freeze_hash", "wheel_status"
    ]

    for field in required_fields:
        if field not in event_data:
            raise ValueError(f"Missing required field: {field}")

    # Write to JSONL file
    with open(log_file, 'a', encoding='utf-8') as f:
        f.write(json.dumps(event_data, separators=(',', ':')) + '\n')
```

### Log Consumption
```python
def read_logs(log_file: Path) -> list:
    """Read and parse SMVM log entries"""
    events = []

    with open(log_file, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                event = json.loads(line)
                events.append(event)

    return events
```

## Monitoring & Alerting

### Log Quality Metrics
- **Completeness**: Percentage of logs with all required fields
- **Compliance**: Percentage of logs passing schema validation
- **Redaction**: Percentage of sensitive logs properly redacted
- **Timeliness**: Age of oldest unprocessed logs

### Alert Conditions
- Completeness < 99%: "Log completeness degraded"
- Compliance < 95%: "Log compliance violation"
- Redaction failures: "Sensitive data exposure risk"
- Log volume anomalies: "Unexpected log volume changes"

---

**Version**: 1.0
**Effective Date**: 2024-12-XX
**Review Date**: 2025-06-XX
**Last Updated**: 2024-12-XX

*This logging specification ensures comprehensive auditability and reproducibility of SMVM operations.*
